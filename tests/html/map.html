<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <style>
      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      #map {
        /* configure the size of the map */
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container container-size">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Home</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Profile</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="myMap-tab" data-bs-toggle="tab" data-bs-target="#myMap" type="button" role="tab" aria-controls="myMap" aria-selected="false">myMap</button>
        </li>
      </ul>
      <div class="tab-content tab-size" id="container">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">1...</div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">2...</div>
        <div class="tab-pane fade map-size" id="myMap" role="tabpanel" aria-labelledby="myMap-tab">          
        </div>
      </div>
    </div>
<style>
  html, body {
    height: 100%;
  }
  .container-size {
    height: 100%;
  }
  .tab-size {
    height: calc(100% - 42px);
  }
  .map-size {
    height: 100%;
  }
</style>
    
    <script>
      window.onload = function(){
        // initialize Leaflet
        var map = L.map('myMap').setView({lon: -43.38451394176952, lat: -22.97373306625776}, 12);
        
        // add the OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        }).addTo(map);

        // show the scale bar on the lower left corner
        L.control.scale().addTo(map);

        const urlParams = new URLSearchParams(window.location.search);
        const linha = urlParams.get('linha')

        

        var markerGroup = L.layerGroup();

        const _renderMarkers = () => {    
          
          markerGroup.clearLayers();
          // inserir markers aqui
          axios.get(`http://localhost:3000/v1/brts/linha/${linha}/veiculo`)
          .then(({ data } ) => {
            console.log(data)
            data.map(v => {
              var marker = L.marker([v.latitude,v.longitude ])
              marker.bindPopup(`${v.velocidade}km/h, ${moment(v.dataHora)}`)
              marker.addTo(markerGroup);
            })
          })
          
          markerGroup.addTo(map)
        }
        _renderMarkers();
        setInterval(function() { _renderMarkers() }, 5000);

        var homeTab = document.getElementById('myMap');
        var observer1 = new MutationObserver(function(){
          if(homeTab.style.display != 'none'){
            map.invalidateSize();
            axios.get(`http://localhost:3000/v1/brts/linha/${linha}/trajeto-latlong`)
            .then(({ data } ) => {
              
              data.map(t => {
                var polyline = L.polyline(t.coordinates, {color: t.strokeColor}).addTo(map);
                map.fitBounds(polyline.getBounds());
              })
            })
          }
        });
        observer1.observe(homeTab, {attributes: true}); 
      }
    </script>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
</html>